name: Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'deployments/**'
      - '.github/workflows/infra.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'deployments/**'
      - '.github/workflows/infra.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - prod
          - all

env:
  TF_VERSION: '1.5.0'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-matrix.outputs.environments }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.environment }}" == "all" ]; then
              echo "environments=[\"test\",\"prod\"]" >> $GITHUB_OUTPUT
            else
              echo "environments=[\"${{ github.event.inputs.environment }}\"]" >> $GITHUB_OUTPUT
            fi
          else
            echo "environments=[\"test\"]" >> $GITHUB_OUTPUT
          fi

  terraform:
    name: 'Terraform'
    needs: setup
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.environments) }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      run: terraform init -upgrade
      working-directory: deployments/${{ matrix.environment }}

    - name: Terraform Plan
      run: terraform plan -var="project_id=${{ secrets.GCP_PROJECT_ID }}" -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" -var="cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}"
      working-directory: deployments/${{ matrix.environment }}

    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
      run: terraform apply -auto-approve -var="project_id=${{ secrets.GCP_PROJECT_ID }}" -var="cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" -var="cloudflare_zone_id=${{ secrets.CLOUDFLARE_ZONE_ID }}"
      working-directory: deployments/${{ matrix.environment }}

